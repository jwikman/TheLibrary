name: Build Linux (Full Test)

on:
  workflow_dispatch:
  workflow_call:
  push:
    paths:
      - '.github/workflows/build-linux.yml'
      - 'scripts/deploy-bc-container-local.ps1'
      - 'scripts/run-tests-odata.ps1'

env:
  AL_VERSION: '17.0.28.6483-beta'
  BCDEV_REPO: 'https://github.com/StefanMaron/BCDevOnLinux.git'
  BCDEV_BRANCH: 'main'
  BC_VERSION: '26.3.36158.36341'
  PLATFORM_VERSION: '26.0.38176'

jobs:
  build-linux-full-test:
    runs-on: ubuntu-latest
    name: Linux Full Test Build

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Record start time
      run: |
        # Function to format bc output to ensure leading zero for decimals
        format_duration() {
            echo "$1" | sed 's/^\./0./'
        }
        START_TIME=$(date -Iseconds)
        START_EPOCH=$(date +%s.%N)
        echo "BUILD_START_TIME=$START_TIME" >> $GITHUB_ENV
        echo "BUILD_START_EPOCH=$START_EPOCH" >> $GITHUB_ENV
        echo "Build started at: $START_TIME"

    - name: Setup .NET 8.0
      run: |
        echo "Installing .NET 8.0 SDK..."
        SETUP_START=$(date +%s.%N)

        # .NET SDK is pre-installed on ubuntu-latest runners
        # Just verify it's available
        dotnet --version

        # Install AL Language development tools
        echo "Installing BC Development Tools (version $AL_VERSION)..."
        dotnet tool install -g Microsoft.Dynamics.BusinessCentral.Development.Tools.Linux --version $AL_VERSION

        # Ensure dotnet tools are in PATH
        export PATH="$PATH:$HOME/.dotnet/tools"
        echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

    - name: Verify BC Development Tools installation
      run: |
        echo "Verifying BC Development Tools installation..."
        # Test AL command directly (ignore exit code since al --version returns 1)
        al --version || true

        SETUP_END=$(date +%s.%N)
        SETUP_DURATION=$(echo "$SETUP_END - $BUILD_START_EPOCH" | bc -l | sed 's/^\./0./')
        echo "SETUP_DURATION=$SETUP_DURATION" >> $GITHUB_ENV
        echo "Setup (.NET + AL tools + verification) took: $SETUP_DURATION seconds"

    - name: Create dependencies directory
      run: |
        DIR_START=$(date +%s.%N)
        mkdir -p .alpackages
        DIR_END=$(date +%s.%N)
        DIR_DURATION=$(echo "$DIR_END - $DIR_START" | bc -l | sed 's/^\./0./')
        echo "DIR_CREATION_DURATION=$DIR_DURATION" >> $GITHUB_ENV
        echo "Directory creation took: $DIR_DURATION seconds"

    - name: Download BC Symbol Packages
      run: |
        echo "Downloading Business Central symbol packages from Microsoft feed..."
        DOWNLOAD_START=$(date +%s.%N)

        # Microsoft BC Symbols NuGet feed
        BC_FEED="https://dynamicssmb2.pkgs.visualstudio.com/DynamicsBCPublicFeeds/_packaging/MSSymbols/nuget/v3/index.json"

        # Download packages directly using the discovered package base URL
        BC_BASE_URL="https://dynamicssmb2.pkgs.visualstudio.com/571e802d-b44b-45ec-bd41-4cfddec73b44/_packaging/b656b10c-3de0-440c-900c-bc2e4e86d84c/nuget/v3/flat2"

        mkdir -p temp_packages

        echo "Downloading Microsoft.SystemApplication.US.symbols..."
        curl -L -s -o "temp_packages/microsoft.systemapplication.us.symbols.nupkg" \
            "$BC_BASE_URL/microsoft.systemapplication.us.symbols.63ca2fa4-4f03-4f2b-a480-172fef340d3f/$BC_VERSION/microsoft.systemapplication.us.symbols.63ca2fa4-4f03-4f2b-a480-172fef340d3f.$BC_VERSION.nupkg" || echo "Failed to download System Application"

        echo "Downloading Microsoft.BaseApplication.US.symbols..."
        curl -L -s -o "temp_packages/microsoft.baseapplication.us.symbols.nupkg" \
            "$BC_BASE_URL/microsoft.baseapplication.us.symbols.437dbf0e-84ff-417a-965d-ed2bb9650972/$BC_VERSION/microsoft.baseapplication.us.symbols.437dbf0e-84ff-417a-965d-ed2bb9650972.$BC_VERSION.nupkg" || echo "Failed to download Base Application"

        echo "Downloading Microsoft.Application.US.symbols..."
        curl -L -s -o "temp_packages/microsoft.application.us.symbols.nupkg" \
            "$BC_BASE_URL/microsoft.application.us.symbols/$BC_VERSION/microsoft.application.us.symbols.$BC_VERSION.nupkg" || echo "Failed to download Application"

        # Second-level dependencies
        echo "Downloading Microsoft.BusinessFoundation.US.symbols (second-level dependency)..."
        curl -L -s -o "temp_packages/microsoft.businessfoundation.us.symbols.nupkg" \
            "$BC_BASE_URL/microsoft.businessfoundation.us.symbols.f3552374-a1f2-4356-848e-196002525837/$BC_VERSION/microsoft.businessfoundation.us.symbols.f3552374-a1f2-4356-848e-196002525837.$BC_VERSION.nupkg" || echo "Failed to download Business Foundation"

        # The actual System package (not SystemApplication)
        echo "Downloading Microsoft.Platform.symbols v$PLATFORM_VERSION (System dependency)..."
        curl -L -s -o "temp_packages/microsoft.platform.symbols.nupkg" \
            "$BC_BASE_URL/microsoft.platform.symbols/$PLATFORM_VERSION/microsoft.platform.symbols.$PLATFORM_VERSION.nupkg" || echo "Failed to download Platform (System)"

        # Test dependencies
        echo "Downloading Microsoft.Any.US.symbols (test dependency)..."
        curl -L -s -o "temp_packages/microsoft.any.us.symbols.nupkg" \
            "$BC_BASE_URL/microsoft.any.us.symbols/$BC_VERSION/microsoft.any.us.symbols.$BC_VERSION.nupkg" || echo "Failed to download Any"

        echo "Downloading Microsoft.Assert.US.symbols (test dependency)..."
        curl -L -s -o "temp_packages/microsoft.assert.us.symbols.nupkg" \
            "$BC_BASE_URL/microsoft.assert.us.symbols/$BC_VERSION/microsoft.assert.us.symbols.$BC_VERSION.nupkg" || echo "Failed to download Assert"

        echo "Downloading Microsoft.TestRunner.US.symbols (test dependency)..."
        curl -L -s -o "temp_packages/microsoft.testrunner.us.symbols.nupkg" \
            "$BC_BASE_URL/microsoft.testrunner.us.symbols/$BC_VERSION/microsoft.testrunner.us.symbols.$BC_VERSION.nupkg" || echo "Failed to download Test Runner"

        echo "Downloading Microsoft.LibraryVariableStorage.US.symbols (test dependency)..."
        curl -L -s -o "temp_packages/microsoft.libraryvariablestorage.us.symbols.nupkg" \
            "$BC_BASE_URL/microsoft.libraryvariablestorage.us.symbols/$BC_VERSION/microsoft.libraryvariablestorage.us.symbols.$BC_VERSION.nupkg" || echo "Failed to download Library Variable Storage"

        # Extract .nupkg files (which are zip files)
        mkdir -p temp_packages/extracted
        for nupkg in temp_packages/*.nupkg; do
            if [ -f "$nupkg" ] && [ -s "$nupkg" ]; then
                echo "Extracting $(basename "$nupkg")..."
                mkdir -p "temp_packages/extracted/$(basename "$nupkg" .nupkg)"
                unzip -q "$nupkg" -d "temp_packages/extracted/$(basename "$nupkg" .nupkg)" || echo "Failed to extract $nupkg"
            else
                echo "Skipping empty or missing file: $(basename "$nupkg")"
            fi
        done

        # Extract .app files from downloaded packages
        find temp_packages -name "*.app" -type f -exec cp {} .alpackages/ \;

        # Clean up temporary files
        rm -rf temp_packages

        DOWNLOAD_END=$(date +%s.%N)
        DOWNLOAD_DURATION=$(echo "$DOWNLOAD_END - $DOWNLOAD_START" | bc -l | sed 's/^\./0./')
        echo "SYSTEM_DOWNLOAD_DURATION=$DOWNLOAD_DURATION" >> $GITHUB_ENV
        echo "SYSTEM_EXTRACT_DURATION=0" >> $GITHUB_ENV
        echo "BC symbols download took: $DOWNLOAD_DURATION seconds"

        # List downloaded symbols
        echo "Downloaded symbol packages:"
        ls -la .alpackages/

    - name: Calculate total dependency time
      run: |
        # Calculate total time for BC symbol downloads
        echo "BASE_DOWNLOAD_DURATION=0" >> $GITHUB_ENV
        echo "BASE_EXTRACT_DURATION=0" >> $GITHUB_ENV
        TOTAL_DEP_TIME=$(echo "$SYSTEM_DOWNLOAD_DURATION + $SYSTEM_EXTRACT_DURATION" | bc -l | sed 's/^\./0./')
        echo "TOTAL_DEPENDENCY_DURATION=$TOTAL_DEP_TIME" >> $GITHUB_ENV
        echo "Total dependency handling: $TOTAL_DEP_TIME seconds"

    - name: Pre-compilation setup
      run: |
        SETUP_START=$(date +%s.%N)
        # No bin directory needed - AL compiler outputs to project root by default
        SETUP_END=$(date +%s.%N)
        SETUP_DURATION=$(echo "$SETUP_END - $SETUP_START" | bc -l | sed 's/^\./0./')
        echo "PRECOMPILE_SETUP_DURATION=$SETUP_DURATION" >> $GITHUB_ENV
        echo "Pre-compilation setup: $SETUP_DURATION seconds"

    - name: Compile Main App
      run: |
        echo "Compiling The Library (main App)..."
        COMPILE_START=$(date +%s.%N)

        if al compile /project:"./App" /packagecachepath:".alpackages"; then
            COMPILE_END=$(date +%s.%N)
            COMPILE_DURATION=$(echo "$COMPILE_END - $COMPILE_START" | bc -l | sed 's/^\./0./')
            echo "COMPILE_DURATION=$COMPILE_DURATION" >> $GITHUB_ENV
            echo "Main app compilation took: $COMPILE_DURATION seconds"
            echo "Main app compilation successful"
        else
            echo "Main app compilation failed with exit code: $?"
            exit 1
        fi

    - name: Copy Main App to .alpackages
      run: |
        # Copy compiled main app to .alpackages so TestApp can reference it
        echo "Copying compiled main app to .alpackages..."
        find ./App -maxdepth 1 -name "*.app" -type f -exec cp {} .alpackages/ \;
        echo "Main app copied to .alpackages"

    - name: Compile Test App
      run: |
        echo "Compiling The Library Tester (TestApp)..."
        TEST_COMPILE_START=$(date +%s.%N)

        if al compile /project:"./TestApp" /packagecachepath:".alpackages"; then
            TEST_COMPILE_END=$(date +%s.%N)
            TEST_COMPILE_DURATION=$(echo "$TEST_COMPILE_END - $TEST_COMPILE_START" | bc -l | sed 's/^\./0./')
            echo "TEST_COMPILE_DURATION=$TEST_COMPILE_DURATION" >> $GITHUB_ENV
            echo "Test app compilation took: $TEST_COMPILE_DURATION seconds"
            echo "Test app compilation successful"
        else
            echo "Test app compilation failed with exit code: $?"
            exit 1
        fi

    - name: Post-compilation analysis
      run: |
        ANALYSIS_START=$(date +%s.%N)

        # Analyze Main App
        echo "Main App compiled files:"
        APP_COUNT=0
        TOTAL_SIZE_BYTES=0

        find ./App -maxdepth 1 -type f -name "*.app" | while read file; do
            SIZE_BYTES=$(stat -c%s "$file" 2>/dev/null || echo "0")
            SIZE_KB=$(echo "scale=2; $SIZE_BYTES / 1024" | bc -l | sed 's/^\./0./')
            echo "  $(basename "$file") - ${SIZE_KB} KB"
        done

        # Count apps and calculate total size
        APP_COUNT=$(find ./App -maxdepth 1 -type f -name "*.app" | wc -l)
        if [ "$APP_COUNT" -gt 0 ]; then
            TOTAL_SIZE_BYTES=$(find ./App -maxdepth 1 -type f -name "*.app" -exec stat -c%s {} + 2>/dev/null | awk '{sum+=$1} END {print sum}' || echo "0")
            TOTAL_SIZE_KB=$(echo "scale=2; $TOTAL_SIZE_BYTES / 1024" | bc -l | sed 's/^\./0./')
            echo "APP_COUNT=$APP_COUNT" >> $GITHUB_ENV
            echo "TOTAL_APP_SIZE_KB=$TOTAL_SIZE_KB" >> $GITHUB_ENV
            echo "Total main app size: ${TOTAL_SIZE_KB} KB"
        fi

        # Analyze Test App
        echo "Test App compiled files:"
        TEST_APP_COUNT=$(find ./TestApp -maxdepth 1 -type f -name "*.app" | wc -l)
        if [ "$TEST_APP_COUNT" -gt 0 ]; then
            TEST_SIZE_BYTES=$(find ./TestApp -maxdepth 1 -type f -name "*.app" -exec stat -c%s {} + 2>/dev/null | awk '{sum+=$1} END {print sum}' || echo "0")
            TEST_SIZE_KB=$(echo "scale=2; $TEST_SIZE_BYTES / 1024" | bc -l | sed 's/^\./0./')
            echo "TEST_APP_COUNT=$TEST_APP_COUNT" >> $GITHUB_ENV
            echo "TOTAL_TEST_SIZE_KB=$TEST_SIZE_KB" >> $GITHUB_ENV
            echo "Total test app size: ${TEST_SIZE_KB} KB"
        fi

        ANALYSIS_END=$(date +%s.%N)
        ANALYSIS_DURATION=$(echo "$ANALYSIS_END - $ANALYSIS_START" | bc -l | sed 's/^\./0./')
        echo "POST_COMPILE_ANALYSIS_DURATION=$ANALYSIS_DURATION" >> $GITHUB_ENV
        echo "Post-compilation analysis: $ANALYSIS_DURATION seconds"

    - name: Setup Docker for BC Container
      run: |
        echo "Setting up Docker environment..."
        DOCKER_SETUP_START=$(date +%s.%N)

        # Verify Docker is available
        docker --version
        docker compose version

        DOCKER_SETUP_END=$(date +%s.%N)
        DOCKER_SETUP_DURATION=$(echo "$DOCKER_SETUP_END - $DOCKER_SETUP_START" | bc -l | sed 's/^\./0./')
        echo "DOCKER_SETUP_DURATION=$DOCKER_SETUP_DURATION" >> $GITHUB_ENV
        echo "Docker setup took: $DOCKER_SETUP_DURATION seconds"

    - name: Clone BCDevOnLinux repository
      run: |
        echo "Cloning BCDevOnLinux repository..."
        CLONE_START=$(date +%s.%N)

        # Clone the repository to a temporary location
        git clone --branch ${{ env.BCDEV_BRANCH }} --depth 1 ${{ env.BCDEV_REPO }} bcdev-temp

        CLONE_END=$(date +%s.%N)
        CLONE_DURATION=$(echo "$CLONE_END - $CLONE_START" | bc -l | sed 's/^\./0./')
        echo "BCDEV_CLONE_DURATION=$CLONE_DURATION" >> $GITHUB_ENV
        echo "BCDevOnLinux clone took: $CLONE_DURATION seconds"

    - name: Pull BC Wine Base Image
      run: |
        echo "Starting container build process (including base image pull)..."
        CONTAINER_BUILD_START=$(date +%s.%N)
        echo "CONTAINER_BUILD_START=$CONTAINER_BUILD_START" >> $GITHUB_ENV

        echo "Pulling BC Wine base image..."
        BASE_IMAGE_PULL_START=$(date +%s.%N)

        # Pull the base image separately (faster than pulling during build)
        docker pull stefanmaronbc/bc-wine-base:latest

        BASE_IMAGE_PULL_END=$(date +%s.%N)
        BASE_IMAGE_PULL_DURATION=$(echo "$BASE_IMAGE_PULL_END - $BASE_IMAGE_PULL_START" | bc -l | sed 's/^\./0./')
        echo "BASE_IMAGE_PULL_DURATION=$BASE_IMAGE_PULL_DURATION" >> $GITHUB_ENV
        echo "Base image pull took: $BASE_IMAGE_PULL_DURATION seconds"

    - name: Build BC Container with Docker Compose
      run: |
        echo "Building Business Central container..."
        cd bcdev-temp

        # Build the container using docker compose
        docker compose build

        CONTAINER_BUILD_END=$(date +%s.%N)
        CONTAINER_BUILD_DURATION=$(echo "$CONTAINER_BUILD_END - $CONTAINER_BUILD_START" | bc -l | sed 's/^\./0./')
        echo "CONTAINER_BUILD_DURATION=$CONTAINER_BUILD_DURATION" >> $GITHUB_ENV
        echo "Container build took: $CONTAINER_BUILD_DURATION seconds"
        cd ..

    - name: Start BC Container
      run: |
        echo "Starting Business Central container..."
        CONTAINER_START_TIME=$(date +%s.%N)
        cd bcdev-temp

        # Start the container
        docker compose up -d

        # Wait for container to become healthy (can take up to 10 minutes)
        echo "Waiting for BC container to become healthy (this can take up to 10 minutes)..."
        CONTAINER_NAME=$(docker compose ps -q | head -n 1)
        MAX_WAIT=1200  # 20 minutes
        ELAPSED=0
        HEALTH_STATUS=""
        PREV_HEALTH_STATUS=""

        while [ $ELAPSED -lt $MAX_WAIT ]; do
            HEALTH_STATUS=$(docker inspect --format='{{.State.Health.Status}}' $CONTAINER_NAME 2>/dev/null || echo "unknown")

            if [ "$HEALTH_STATUS" = "healthy" ]; then
                echo "✓ BC container is healthy and ready"
                break
            fi

            # Check if container became unhealthy (was starting, now unhealthy)
            if [ "$HEALTH_STATUS" = "unhealthy" ] && [ "$PREV_HEALTH_STATUS" != "unhealthy" ]; then
                echo "⚠ Container became unhealthy - printing logs for investigation:"
                docker compose ps
                docker compose logs --tail=100
            fi

            echo "Container status: $HEALTH_STATUS (waited ${ELAPSED}s / ${MAX_WAIT}s)"
            PREV_HEALTH_STATUS="$HEALTH_STATUS"
            sleep 10
            ELAPSED=$((ELAPSED + 10))
        done

        # Final health check after loop completes (in case timeout was reached while healthy)
        HEALTH_STATUS=$(docker inspect --format='{{.State.Health.Status}}' $CONTAINER_NAME 2>/dev/null || echo "unknown")
        if [ "$HEALTH_STATUS" != "healthy" ]; then
            echo "ERROR: Container did not become healthy within $MAX_WAIT seconds"
            echo "Final status: $HEALTH_STATUS"
            echo "Printing full container logs:"
            docker compose ps
            docker compose logs
            exit 1
        fi

        # Check container status
        docker compose ps
        docker compose logs

        CONTAINER_START_END=$(date +%s.%N)
        CONTAINER_START_DURATION=$(echo "$CONTAINER_START_END - $CONTAINER_START_TIME" | bc -l | sed 's/^\./0./')
        echo "CONTAINER_START_DURATION=$CONTAINER_START_DURATION" >> $GITHUB_ENV
        echo "Container startup took: $CONTAINER_START_DURATION seconds"
        cd ..

    - name: Publish Main App to Container
      run: |
        echo "Publishing The Library (main app) to BC container..."
        PUBLISH_START=$(date +%s.%N)

        # Find the main app file
        APP_FILE=$(find ./App -maxdepth 1 -name "*.app" -type f | head -n 1)
        if [ -z "$APP_FILE" ]; then
            echo "ERROR: No main app file found for publishing"
            exit 1
        fi

        echo "Publishing app file: $APP_FILE"

        # Publish extension to BC container using API
        curl -u "admin:Admin123!" \
             -F "file=@$APP_FILE" \
             "http://localhost:7049/BC/dev/apps?tenant=default&SchemaUpdateMode=synchronize&DependencyPublishingOption=default"

        PUBLISH_END=$(date +%s.%N)
        PUBLISH_DURATION=$(echo "$PUBLISH_END - $PUBLISH_START" | bc -l | sed 's/^\./0./')
        echo "PUBLISH_DURATION=$PUBLISH_DURATION" >> $GITHUB_ENV
        echo "Main app publishing took: $PUBLISH_DURATION seconds"

    - name: Publish Test App to Container
      run: |
        echo "Publishing The Library Tester (test app) to BC container..."
        TEST_PUBLISH_START=$(date +%s.%N)

        # Find the test app file (excluding .dep.app files)
        TEST_APP_FILE=$(find ./TestApp -maxdepth 1 -name "*.app" -type f ! -name "*.dep.app" | head -n 1)
        if [ -z "$TEST_APP_FILE" ]; then
            echo "ERROR: No test app file found for publishing"
            exit 1
        fi

        echo "Publishing test app file: $TEST_APP_FILE"

        # Publish extension to BC container using API
        curl -u "admin:Admin123!" \
             -F "file=@$TEST_APP_FILE" \
             "http://localhost:7049/BC/dev/apps?tenant=default&SchemaUpdateMode=synchronize&DependencyPublishingOption=default"

        TEST_PUBLISH_END=$(date +%s.%N)
        TEST_PUBLISH_DURATION=$(echo "$TEST_PUBLISH_END - $TEST_PUBLISH_START" | bc -l | sed 's/^\./0./')
        echo "TEST_PUBLISH_DURATION=$TEST_PUBLISH_DURATION" >> $GITHUB_ENV
        echo "Test app publishing took: $TEST_PUBLISH_DURATION seconds"

    - name: Run AL Tests in Container via OData
      run: |
        echo "Running AL tests in BC container via OData API..."
        TEST_START=$(date +%s.%N)

        # Execute test suite via OData API using PowerShell script
        # The script will execute test codeunit 70454 (LIB Test Suite)
        pwsh ./scripts/run-tests-odata.ps1 \
          -BaseUrl "http://localhost:7048/BC" \
          -Tenant "default" \
          -Username "admin" \
          -Password "Admin123!" \
          -CodeunitId 70454 \
          -MaxWaitSeconds 300

        TEST_EXIT_CODE=$?

        TEST_END=$(date +%s.%N)
        TEST_DURATION=$(echo "$TEST_END - $TEST_START" | bc -l | sed 's/^\./0./')
        echo "TEST_DURATION=$TEST_DURATION" >> $GITHUB_ENV
        echo "Testing took: $TEST_DURATION seconds"

        # Exit with the test script's exit code
        exit $TEST_EXIT_CODE

    - name: Calculate comprehensive build metrics
      run: |
        END_TIME=$(date -Iseconds)
        END_EPOCH=$(date +%s.%N)
        TOTAL_DURATION=$(echo "$END_EPOCH - $BUILD_START_EPOCH" | bc -l | sed 's/^\./0./')

        echo "=== LINUX FULL BUILD & TEST PERFORMANCE SUMMARY ==="
        echo "Build Start Time: $BUILD_START_TIME"
        echo "Build End Time: $END_TIME"
        echo ""
        echo "=== DETAILED TIMINGS ==="
        echo "Setup (.NET + AL tools): $SETUP_DURATION seconds"
        echo "Directory Creation: $DIR_CREATION_DURATION seconds"
        echo "System App Download: $SYSTEM_DOWNLOAD_DURATION seconds"
        echo "Total Dependencies: $TOTAL_DEPENDENCY_DURATION seconds"
        echo "Pre-compile Setup: $PRECOMPILE_SETUP_DURATION seconds"
        echo "Main App Compilation: $COMPILE_DURATION seconds"
        echo "Test App Compilation: $TEST_COMPILE_DURATION seconds"
        echo "Post-compile Analysis: $POST_COMPILE_ANALYSIS_DURATION seconds"
        echo "Docker Setup: $DOCKER_SETUP_DURATION seconds"
        echo "BCDevOnLinux Clone: $BCDEV_CLONE_DURATION seconds"
        echo "Base Image Pull: $BASE_IMAGE_PULL_DURATION seconds"
        echo "Container Build: $CONTAINER_BUILD_DURATION seconds"
        echo "Container Start: $CONTAINER_START_DURATION seconds"
        echo "Main App Publishing: $PUBLISH_DURATION seconds"
        echo "Test App Publishing: $TEST_PUBLISH_DURATION seconds"
        echo "Test Execution: $TEST_DURATION seconds"
        echo ""
        echo "=== TOTAL DURATION ==="
        echo "Total: $TOTAL_DURATION seconds"
        echo ""
        echo "=== BUILD ARTIFACTS ==="
        if [ -n "$APP_COUNT" ]; then echo "Main Apps Compiled: $APP_COUNT"; fi
        if [ -n "$TOTAL_APP_SIZE_KB" ]; then echo "Main App Size: $TOTAL_APP_SIZE_KB KB"; fi
        if [ -n "$TEST_APP_COUNT" ]; then echo "Test Apps Compiled: $TEST_APP_COUNT"; fi
        if [ -n "$TOTAL_TEST_SIZE_KB" ]; then echo "Test App Size: $TOTAL_TEST_SIZE_KB KB"; fi

    - name: Display system information
      run: |
        echo "=== SYSTEM INFORMATION ==="
        echo "OS: $(lsb_release -d | cut -f2)"
        echo "Kernel: $(uname -r)"
        echo "CPU: $(lscpu | grep 'Model name' | cut -d: -f2 | xargs)"
        echo "Memory: $(free -h | grep Mem | awk '{print $2}')"
        echo "Disk Space: $(df -h / | tail -1 | awk '{print $4}' | xargs) available"
